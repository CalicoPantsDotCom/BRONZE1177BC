{% extends "base.html" %}

{% block content %}
<!-- Sticky Resource Bar -->
<div class="sticky-resources">
    <div class="resource-item">
        <span class="resource-label">🌾 Grain:</span>
        <span class="resource-value">{{ game.grain }}</span>
    </div>
    <div class="resource-item">
        <span class="resource-label">🪵 Timber:</span>
        <span class="resource-value">{{ game.timber }}</span>
    </div>
    <div class="resource-item">
        <span class="resource-label">⚒️ Bronze:</span>
        <span class="resource-value">{{ game.bronze }}</span>
    </div>
    <div class="resource-item turn-counter">
        <span class="resource-label">Turn:</span>
        <span class="resource-value">{{ game.turn }}/{{ game.max_turns }}</span>
    </div>
</div>

<!-- Main Game Layout: Sidebar + Content -->
<div class="game-layout">
    <!-- Sidebar: Turn History -->
    <aside class="game-sidebar">
        <div class="sidebar-toggle" onclick="document.querySelector('.game-sidebar').classList.toggle('open')">
            📜 History
        </div>

        <div class="sidebar-content">
            <!-- Current Turn Actions -->
            {% if game.current_turn_actions %}
            <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">
                    <strong>📝 Turn {{ game.turn }} Actions</strong>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                    {% for action in game.current_turn_actions %}
                        <li>✓ <strong>{{ action.name }}:</strong> {{ action.effects }}</li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Previous Turn Summary -->
            {% if game.previous_turn_summary %}
            <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">
                    <strong>📜 Turn {{ game.previous_turn_summary.turn_number }} Summary</strong>
                </div>
                <div class="card-body">
                    {% if game.previous_turn_summary.actions %}
                    <h6 class="text-primary">Actions:</h6>
                    <ul class="mb-2" style="font-size: 0.85rem;">
                    {% for action in game.previous_turn_summary.actions %}
                        <li><strong>{{ action.name }}:</strong> {{ action.effects }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}

                    {% if game.previous_turn_summary.events %}
                    <h6 class="text-warning">Events:</h6>
                    <ul class="mb-2" style="font-size: 0.85rem;">
                    {% for event in game.previous_turn_summary.events %}
                        <li>⚠️ {{ event }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}

                    {% if game.previous_turn_summary.income %}
                    <h6 class="text-success">Income:</h6>
                    <ul class="mb-2" style="font-size: 0.85rem;">
                    {% for income in game.previous_turn_summary.income %}
                        <li>💰 {{ income }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}

                    {% if game.previous_turn_summary.drift %}
                    <h6 class="text-muted">Drift:</h6>
                    <ul class="mb-0" style="font-size: 0.85rem;">
                    {% for drift in game.previous_turn_summary.drift %}
                        <li>📉 {{ drift }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if not game.current_turn_actions and not game.previous_turn_summary %}
            <div class="alert alert-info">
                <small>Turn history will appear here</small>
            </div>
            {% endif %}
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="game-content">
<div class="row">
    <!-- Game Status -->
    <div class="col-12 mb-3">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <span><strong>Turn:</strong> {{ game.turn }} / {{ game.max_turns }} <span class="badge bg-secondary">{{ game.difficulty.capitalize() }}</span></span>
            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">🔄 Refresh</button>
        </div>
    </div>

    <!-- Messages -->
    <div class="col-12 mb-3" id="message-area">
        {% for msg in game.message_log %}
        <div class="alert alert-{{ msg.type }} alert-dismissible fade show" role="alert">
            {{ msg.text }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>

    <!-- Resources Panel -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <strong>📦 Resources</strong>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>🌾 Grain:</span>
                    <strong>{{ game.grain }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>🪵 Timber:</span>
                    <strong>{{ game.timber }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>🔶 Bronze:</span>
                    <strong>{{ game.bronze }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Panel -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <strong>📊 Core Metrics</strong>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>⚔️ Military:</span>
                    <strong>{{ game.military }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>🛡️ Stability:</span>
                    <strong class="{{ 'text-danger' if game.stability < 30 else 'text-success' if game.stability > 60 else '' }}">
                        {{ game.stability }}
                    </strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>👑 Prestige:</span>
                    <strong>{{ game.prestige }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Crisis Panel -->
    <div class="col-lg-4 col-md-12 mb-3">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <strong>⚠️ Crisis Level</strong>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <span>🔥 Collapse:</span>
                    <h3 class="mb-0 {{ 'text-danger' if game.collapse > 70 else 'text-warning' if game.collapse > 40 else 'text-success' }}">
                        {{ game.collapse }}
                    </h3>
                </div>
                <div class="progress mt-2" style="height: 20px;">
                    <div class="progress-bar
                        {{ 'bg-danger' if game.collapse > 70 else 'bg-warning' if game.collapse > 40 else 'bg-success' }}"
                        role="progressbar"
                        style="width: {{ game.collapse }}%">
                        {{ game.collapse }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3">🎮 Actions</h4>
    </div>

    <!-- Basic Actions -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>Basic Actions</strong>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('action', action_name='harvest') }}">
                    <button type="submit" class="btn btn-success btn-sm w-100 mb-2">
                        🌾 Harvest (+15G, +10B)
                        {% if not game.has_used_free_harvest %}
                        <span class="badge bg-warning text-dark">FREE</span>
                        {% else %}
                        <span class="badge bg-danger">Ends Turn</span>
                        {% endif %}
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='gather_timber') }}">
                    <button type="submit" class="btn btn-outline-success btn-sm w-100 mb-2">
                        🪵 Gather Timber (-8G → +10T)
                        {% if not game.has_used_free_harvest %}
                        <span class="badge bg-warning text-dark">FREE</span>
                        {% else %}
                        <span class="badge bg-danger">Ends Turn</span>
                        {% endif %}
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='fortify') }}">
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                        ⚔️ Fortify (+5M, -5S)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Buildings -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>🏗️ Buildings</strong>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('action', action_name='build_bronze_mine') }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.has_bronze_mine else '' }}>
                        {{ '✅' if game.has_bronze_mine else '🔶' }} Bronze Mine (15G, 10T)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='build_granary') }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.has_granary else '' }}>
                        {{ '✅' if game.has_granary else '🌾' }} Granary (20G, 15T)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='build_barracks') }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.has_barracks else '' }}>
                        {{ '✅' if game.has_barracks else '⚔️' }} Barracks (25G, 20T, 10B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='build_palace') }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.has_palace else '' }}>
                        {{ '✅' if game.has_palace else '👑' }} Palace (30G, 25T, 15B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='build_lighthouse') }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.has_lighthouse else '' }}>
                        {{ '✅' if game.has_lighthouse else '🗼' }} Lighthouse (20G, 20T)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='build_watchtower') }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100" {{ 'disabled' if game.has_watchtower else '' }}>
                        {{ '✅' if game.has_watchtower else '🏰' }} Watchtower (15G, 15T)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Research & Diplomacy -->
    <div class="col-lg-4 col-md-12 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>🔬 Research & 🤝 Diplomacy</strong>
            </div>
            <div class="card-body">
                <small class="text-muted d-block mb-2">Research:</small>
                <form method="POST" action="{{ url_for('action', action_name='research_imperial_bureaucracy') }}">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2" {{ 'disabled' if game.has_imperial_bureaucracy else '' }}>
                        {{ '✅' if game.has_imperial_bureaucracy else '📜' }} Imperial Bureaucracy (20G, 20P)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='research_tin_trade_routes') }}">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2" {{ 'disabled' if game.has_tin_trade_routes else '' }}>
                        {{ '✅' if game.has_tin_trade_routes else '🚢' }} Tin Trade Routes (25G, 15B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='research_phalanx_formation') }}">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2" {{ 'disabled' if game.has_phalanx_formation else '' }}>
                        {{ '✅' if game.has_phalanx_formation else '🛡️' }} Phalanx (20B, 25M)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='research_diplomatic_marriage') }}">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-3" {{ 'disabled' if game.has_diplomatic_marriage else '' }}>
                        {{ '✅' if game.has_diplomatic_marriage else '💍' }} Diplomatic Marriage (30P)
                    </button>
                </form>

                <small class="text-muted d-block mb-2">Diplomacy:</small>
                <form method="POST" action="{{ url_for('action', action_name='send_tribute') }}">
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        🎁 Send Tribute (15G, 10B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='form_alliance') }}">
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        🤝 Form Alliance (15P)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action', action_name='host_festival') }}">
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100 mb-3">
                        🎉 Host Festival (20G)
                    </button>
                </form>

                <form method="POST" action="{{ url_for('action', action_name='withdraw') }}">
                    <button type="submit" class="btn btn-danger btn-sm w-100" {{ 'disabled' if game.stability < 45 else '' }}>
                        ⚠️ Withdraw from Alliance
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Turn Info (Auto-ends when free harvest + paid action taken) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info text-center">
            {% if not game.has_used_free_harvest and not game.has_taken_paid_action %}
                <strong>⏳ Turn {{ game.turn }}:</strong> Take ONE free harvest/timber, then ONE paid action
            {% elif game.has_used_free_harvest and not game.has_taken_paid_action %}
                <strong>⏳ Turn {{ game.turn }}:</strong> Free harvest used! Now take your paid action
            {% elif not game.has_used_free_harvest and game.has_taken_paid_action %}
                <strong>⏳ Turn {{ game.turn }}:</strong> Paid action done! Take your free harvest to end turn
            {% endif %}
        </div>
    </div>
</div>

<!-- Legend -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">
                    <strong>Legend:</strong>
                    G=Grain | T=Timber | B=Bronze | M=Military | S=Stability | P=Prestige |
                    ✅=Built | <strong class="text-success">ONE FREE harvest/timber per turn</strong> |
                    <strong class="text-warning">ONE paid action per turn</strong> | Turn auto-ends after BOTH
                </small>
            </div>
        </div>
    </div>
</div>

</div> <!-- end row -->
    </main> <!-- end game-content -->
</div> <!-- end game-layout -->

{% endblock %}
