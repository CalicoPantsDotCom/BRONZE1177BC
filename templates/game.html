{% extends "base.html" %}

{% block content %}
<!-- Sticky Resource & Metrics Bar -->
<div class="sticky-bar">
    <!-- Top Row: Resources -->
    <div class="sticky-resources">
        <div class="resource-item">
            <span class="resource-label">🌾 Grain:</span>
            <span class="resource-value">{{ game.grain }}</span>
        </div>
        <div class="resource-item">
            <span class="resource-label">🪵 Timber:</span>
            <span class="resource-value">{{ game.timber }}</span>
        </div>
        <div class="resource-item">
            <span class="resource-label">⚒️ Bronze:</span>
            <span class="resource-value">{{ game.bronze }}</span>
        </div>
        <div class="resource-item turn-counter">
            <span class="resource-label">Turn:</span>
            <span class="resource-value">{{ game.turn }}/{{ game.max_turns }}</span>
        </div>
    </div>

    <!-- Bottom Row: Metrics with Bars -->
    <div class="sticky-metrics">
        <!-- Military -->
        <div class="metric-item">
            <div class="metric-header">
                <span class="metric-label">⚔️ Military</span>
                <span class="metric-value">{{ game.military }}</span>
            </div>
            <div class="metric-bar-container">
                <div class="threshold-line" style="left: 20%;"></div>
                <div class="metric-bar metric-military" style="width: {{ game.military }}%;"></div>
            </div>
        </div>

        <!-- Stability -->
        <div class="metric-item">
            <div class="metric-header">
                <span class="metric-label">🏛️ Stability</span>
                <span class="metric-value">{{ game.stability }}</span>
            </div>
            <div class="metric-bar-container">
                <div class="threshold-line warning" style="left: 30%;"></div>
                <div class="threshold-line danger" style="left: 15%;"></div>
                <div class="metric-bar metric-stability" style="width: {{ game.stability }}%;"></div>
            </div>
        </div>

        <!-- Prestige -->
        <div class="metric-item">
            <div class="metric-header">
                <span class="metric-label">👑 Prestige</span>
                <span class="metric-value">{{ game.prestige }}</span>
            </div>
            <div class="metric-bar-container">
                <div class="threshold-line" style="left: 50%;"></div>
                <div class="threshold-line good" style="left: 70%;"></div>
                <div class="metric-bar metric-prestige" style="width: {{ game.prestige }}%;"></div>
            </div>
        </div>

        <!-- Collapse -->
        <div class="metric-item">
            <div class="metric-header">
                <span class="metric-label">💀 Collapse</span>
                <span class="metric-value">{{ game.collapse }}</span>
            </div>
            <div class="metric-bar-container">
                <div class="threshold-line warning" style="left: 70%;"></div>
                <div class="threshold-line danger" style="left: 85%;"></div>
                <div class="metric-bar metric-collapse" style="width: {{ game.collapse }}%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Main Game Layout: Sidebar + Content -->
<div class="game-layout">
    <!-- Sidebar: Turn History -->
    <aside class="game-sidebar">
        <div class="sidebar-toggle" onclick="document.querySelector('.game-sidebar').classList.toggle('open')">
            📜 History
        </div>

        <div class="sidebar-content">
            <!-- Current Turn Actions -->
            {% if game.current_turn_actions %}
            <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">
                    <strong>📝 Turn {{ game.turn }} Actions</strong>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                    {% for action in game.current_turn_actions %}
                        <li>✓ <strong>{{ action.name }}:</strong> {{ action.effects }}</li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Previous Turn Summary -->
            {% if game.previous_turn_summary %}
            <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">
                    <strong>📜 Turn {{ game.previous_turn_summary.turn_number }} Summary</strong>
                </div>
                <div class="card-body">
                    {% if game.previous_turn_summary.actions %}
                    <h6 class="text-primary">Actions:</h6>
                    <ul class="mb-2" style="font-size: 0.85rem;">
                    {% for action in game.previous_turn_summary.actions %}
                        <li><strong>{{ action.name }}:</strong> {{ action.effects }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}

                    {% if game.previous_turn_summary.events %}
                    <h6 class="text-warning">Events:</h6>
                    <ul class="mb-2" style="font-size: 0.85rem;">
                    {% for event in game.previous_turn_summary.events %}
                        <li>⚠️ {{ event }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}

                    {% if game.previous_turn_summary.income %}
                    <h6 class="text-success">Income:</h6>
                    <ul class="mb-2" style="font-size: 0.85rem;">
                    {% for income in game.previous_turn_summary.income %}
                        <li>💰 {{ income }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}

                    {% if game.previous_turn_summary.drift %}
                    <h6 class="text-muted">Drift:</h6>
                    <ul class="mb-0" style="font-size: 0.85rem;">
                    {% for drift in game.previous_turn_summary.drift %}
                        <li>📉 {{ drift }}</li>
                    {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if not game.current_turn_actions and not game.previous_turn_summary %}
            <div class="alert alert-info">
                <small>Turn history will appear here</small>
            </div>
            {% endif %}
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="game-content">
    
<!-- Choice Event Modal -->
{% if game.pending_choice %}
<div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><strong>⚠️ {{ game.pending_choice.title }}</strong></h5>
            </div>
            <div class="modal-body">
                <p>{{ game.pending_choice.description }}</p>
                <hr>
                <div class="d-grid gap-2">
                    <form method="POST" action="{{ url_for('choice') }}" class="mb-2">
                        <input type="hidden" name="choice" value="a">
                        <button type="submit" class="btn btn-outline-primary w-100 text-start">
                            <strong>A)</strong> {{ game.pending_choice.choice_a_label }}
                            <br><small class="text-muted">{{ game.pending_choice.choice_a_effects }}</small>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('choice') }}">
                        <input type="hidden" name="choice" value="b">
                        <button type="submit" class="btn btn-outline-secondary w-100 text-start">
                            <strong>B)</strong> {{ game.pending_choice.choice_b_label }}
                            <br><small class="text-muted">{{ game.pending_choice.choice_b_effects }}</small>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Game Status -->
    <div class="col-12 mb-3">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <span><strong>Turn:</strong> {{ game.turn }} / {{ game.max_turns }} <span class="badge bg-secondary">{{ game.difficulty.capitalize() }}</span></span>
            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">🔄 Refresh</button>
        </div>
    </div>

    <!-- Messages -->
    <div class="col-12 mb-3" id="message-area">
        {% for msg in game.message_log %}
        <div class="alert alert-{{ msg.type }} alert-dismissible fade show" role="alert">
            {{ msg.text }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>

    <!-- Resources & Metrics now in sticky bar above - removed redundant panels -->
</div>

<!-- Actions -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3">🎮 Actions</h4>
    </div>

    <!-- Basic Actions -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>Basic Actions</strong>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="harvest">
                    <button type="submit" class="btn btn-success btn-sm w-100 mb-2" {{ 'disabled' if game.free_harvest_used else '' }}>
                        🌾 Harvest (+15G, +10B)
                        {% if not game.free_harvest_used %}
                        <span class="badge bg-warning text-dark">FREE</span>
                        {% else %}
                        <span class="badge bg-secondary">USED</span>
                        {% endif %}
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="gather_timber">
                    <button type="submit" class="btn btn-outline-success btn-sm w-100 mb-2" {{ 'disabled' if game.paid_action_used else '' }}>
                        🪵 Gather Timber (-8G → +10T)
                        {% if game.paid_action_used %}
                        <span class="badge bg-secondary">USED</span>
                        {% endif %}
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="fortify">
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100" {{ 'disabled' if game.paid_action_used else '' }}>
                        ⚔️ Fortify (-10B → +8M)
                        {% if game.paid_action_used %}
                        <span class="badge bg-secondary">USED</span>
                        {% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Buildings -->
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>🏗️ Buildings</strong>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="build_mine">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.builds.bronze_mine or game.paid_action_used else '' }}>
                        {{ '✅' if game.builds.bronze_mine else '🔶' }} Bronze Mine (15G, 20T)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="build_granary">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.builds.granary or game.paid_action_used else '' }}>
                        {{ '✅' if game.builds.granary else '🌾' }} Granary (20G, 15T)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="build_barracks">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.builds.barracks or game.paid_action_used else '' }}>
                        {{ '✅' if game.builds.barracks else '⚔️' }} Barracks (25G, 20T, 10B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="build_palace">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.builds.palace or game.paid_action_used else '' }}>
                        {{ '✅' if game.builds.palace else '👑' }} Palace (30G, 25T, 15B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="build_lighthouse">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-2" {{ 'disabled' if game.builds.lighthouse or game.paid_action_used else '' }}>
                        {{ '✅' if game.builds.lighthouse else '🗼' }} Lighthouse (20G, 20T)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="build_watchtower">
                    <button type="submit" class="btn btn-outline-warning btn-sm w-100" {{ 'disabled' if game.builds.watchtower or game.paid_action_used else '' }}>
                        {{ '✅' if game.builds.watchtower else '🏰' }} Watchtower (15G, 15T)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Research & Diplomacy -->
    <div class="col-lg-4 col-md-12 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>🔬 Research & 🤝 Diplomacy</strong>
            </div>
            <div class="card-body">
                <small class="text-muted d-block mb-2">Research:</small>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="research_ib">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2" {{ 'disabled' if game.tech.imperial_bureaucracy or game.paid_action_used else '' }}>
                        {{ '✅' if game.tech.imperial_bureaucracy else '📜' }} Imperial Bureaucracy (20G, 15K)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="research_tin_trade">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2" {{ 'disabled' if game.tech.tin_trade_routes or game.paid_action_used else '' }}>
                        {{ '✅' if game.tech.tin_trade_routes else '🚢' }} Tin Trade Routes (25G, 15B)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="research_phalanx">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2" {{ 'disabled' if game.tech.phalanx_formation or game.paid_action_used else '' }}>
                        {{ '✅' if game.tech.phalanx_formation else '🛡️' }} Phalanx (20B, 25M)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="research_marriage">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-3" {{ 'disabled' if game.tech.diplomatic_marriage or game.paid_action_used else '' }}>
                        {{ '✅' if game.tech.diplomatic_marriage else '💍' }} Diplomatic Marriage (30P)
                    </button>
                </form>

                <small class="text-muted d-block mb-2">Diplomacy:</small>
                <form method="POST" action="{{ url_for('action') }}" style="margin-bottom: 8px;">
                    <input type="hidden" name="type" value="send_tribute">
                    <select name="target" class="btn btn-sm w-100 mb-1" style="text-align: left; padding: 6px 12px;" {{ 'disabled' if game.paid_action_used else '' }}>
                        <option value="egypt">🏛️ Send Tribute to Egypt</option>
                        <option value="hittites">⚔️ Send Tribute to Hittites</option>
                        <option value="assyria">🦁 Send Tribute to Assyria</option>
                        <option value="mycenae">🏺 Send Tribute to Mycenae</option>
                    </select>
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100" {{ 'disabled' if game.paid_action_used else '' }}>
                        🎁 Send (15G, 10B) → +5P, -3 Collapse
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="form_alliance">
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100 mb-2" {{ 'disabled' if game.paid_action_used else '' }}>
                        🤝 Form Alliance (15P)
                    </button>
                </form>
                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="host_festival">
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100 mb-3" {{ 'disabled' if game.paid_action_used else '' }}>
                        🎉 Host Festival (20G)
                    </button>
                </form>

                <form method="POST" action="{{ url_for('action') }}">
                    <input type="hidden" name="type" value="withdraw">
                    <button type="submit" class="btn btn-danger btn-sm w-100" {{ 'disabled' if game.stability < 45 or game.paid_action_used else '' }}>
                        ⚠️ Withdraw from Alliance
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Turn Info (Auto-ends when free harvest + paid action taken) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info text-center">
            {% if not game.free_harvest_used and not game.paid_action_used %}
                <strong>⏳ Turn {{ game.turn }}:</strong> Take ONE free harvest/timber, then ONE paid action
            {% elif game.free_harvest_used and not game.paid_action_used %}
                <strong>⏳ Turn {{ game.turn }}:</strong> Free harvest used! Now take your paid action
            {% elif not game.free_harvest_used and game.paid_action_used %}
                <strong>⏳ Turn {{ game.turn }}:</strong> Paid action done! Take your free harvest to end turn
            {% else %}
                <strong>✓ Turn {{ game.turn }} Complete!</strong> Ready to end turn
            {% endif %}
        </div>
        {% if game.free_harvest_used and game.paid_action_used %}
        <div class="text-center">
            <form method="POST" action="{{ url_for('end_turn') }}">
                <button type="submit" class="btn btn-primary btn-lg">
                    ⏭️ End Turn {{ game.turn }}
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Legend -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">
                    <strong>Legend:</strong>
                    G=Grain | T=Timber | B=Bronze | K=Knowledge | M=Military | S=Stability | P=Prestige |
                    ✅=Built | <strong class="text-success">ONE FREE harvest per turn</strong> |
                    <strong class="text-warning">ONE paid action per turn</strong>
                </small>
            </div>
        </div>
    </div>
</div>

</div> <!-- end row -->
    </main> <!-- end game-content -->
</div> <!-- end game-layout -->

{% endblock %}
